# Malware Analysis Cheatsheet

This cheatsheet provides a step-by-step guide for both **static** and **dynamic** malware analysis. It covers the tools and techniques used to analyze suspicious files and observe their behavior in a controlled, isolated environment.

---

## **Step-by-Step Static Analysis**

This phase involves examining the binary without executing it to gather preliminary information and check for indicators of malicious functionality.

### **Step 1: Check Basic File Information with `exeinfope.exe`**

1. **Open `exeinfope.exe`** and load `malware.exe`.
2. **Observe Output:**
    - Check if the file is packed or obfuscated (indicators like UPX, Themida, or PECompact).
    - Record the **file type** (e.g., PE32, DLL).
    - Note the **timestamp** of compilation; a recent date can sometimes indicate re-packed malware, while unusual dates can be a sign of tampering.

    > **Note:** If packed, be prepared for unpacking or code emulation. Packed files often hide malicious code within layers of compressed data.

---

### **Step 2: Extract Strings with `strings.exe`**

1. Open a command prompt and run:
    ```bash
    strings.exe malware.exe > malware_strings.txt
    ```

2. Open `malware_strings.txt` and examine:
    - **URLs, IP addresses, and domain names**: These may indicate C2 servers or data exfiltration endpoints.
    - **File paths**: Common suspicious paths include `AppData`, `Temp`, or `Startup` locations.
    - **Keywords**: Look for words like `keylogger`, `shell`, `socket`, and function names like `GetProcAddress` (indicates dynamic loading).

    > **Tip:** Filter out common, benign strings and focus on any that stand out as suspicious or relevant to system activity.

---

### **Step 3: Analyze Hexadecimal Data with `HxD`**

1. Open `malware.exe` in `HxD`.
2. **Scroll through** and look for readable ASCII or Unicode strings that `strings.exe` might have missed.
3. Look for **embedded scripts** (e.g., PowerShell commands), base64-encoded data, or **high entropy regions** (indicative of encrypted/obfuscated data).

    > **High Entropy Check:** Areas with random-looking data often contain encrypted payloads or packed code.

---

### **Step 4: Use `PEStudio` for Detailed PE Analysis**

1. Open `PEStudio` and load `malware.exe`.
2. **Check Imports and Sections:**
    - **Imports**: Look for suspicious Windows API calls. Common malicious APIs include `CreateProcess`, `WriteProcessMemory`, `VirtualAlloc`, and `InternetOpen`.
    - **Sections**: Review each section for unusual permissions (like executable + writable), which may indicate malicious code injection.
3. **Look for Indicators:**
    - PEStudio flags blacklisted imports or malware-related indicators. Document any red flags.
    - Check the **resource section** for embedded data (images, strings) that might be used by the malware.

---

### **Step 5: Identify Potential Persistence Mechanisms**

1. In `PEStudio`, look for references to **registry keys** in typical persistence locations:
    - Common keys include `HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run` and `RunOnce`.
    - If paths point to `Startup` folders or `Temp`, these may also indicate persistence tactics.

---

## **Step-by-Step Dynamic Analysis**

Dynamic analysis allows you to observe the malware’s behavior in real-time. Make sure this analysis is performed in a **fully isolated, sandboxed environment** to avoid infecting the host system or network.

### **Step 1: Environment Setup**

1. **Isolate the system**: Ensure the VM or sandbox is completely disconnected from the internet.
2. **Launch FakeNet**: Run FakeNet to simulate a network environment and capture any outbound network traffic generated by the malware.

---

### **Step 2: Take Initial Snapshots with `Autoruns` and `RegShot`**

1. **Run Autoruns** to capture all startup locations before executing the malware:
    - Save this snapshot for later comparison.
2. **Run RegShot**:
    - Take a **first registry snapshot** (baseline).
    - Save the snapshot with a meaningful name, like `baseline_shot.txt`.

---

### **Step 3: Launch `Process Monitor` and Configure Filters**

1. Open `Process Monitor` and set up the following filters to reduce noise:
    - **Operation:** Set filters for `Process Create`, `RegSetValue`, `CreateFile`, `WriteFile`, and `NetworkConnect`.
    - This helps focus on malware-related actions like process creation, registry modifications, file writes, and network connections.

---

### **Step 4: Execute `malware.exe` and Observe in `Process Monitor`**

1. **Run `malware.exe`** and closely monitor the **Process Monitor** output:
    - Look for **child processes** spawned by the malware (e.g., command shells, PowerShell, or Windows utilities).
    - Document any files created, especially in directories like `AppData`, `Temp`, or `Startup`.
    - Note registry keys written or modified—especially if they suggest persistence, such as `Run` or `RunOnce`.

    > **Example Interpretation:** If you see an executable created in `AppData` or a registry key modified under `HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run`, this suggests persistence. Document file paths, registry entries, and actions for later analysis.

---

### **Step 5: Monitor Network Activity with `FakeNet`**

1. With FakeNet running, observe any **network traffic** generated by `malware.exe`.
    - Take note of **domains, IP addresses, or URLs** contacted by the malware.
    - Record any HTTP requests, headers, or specific patterns (e.g., periodic beacons suggesting C2).

    > **Example Traffic Patterns:** Malware may make repeated attempts to connect to a C2 server. Document these IoCs.

---

### **Step 6: Take a Second Registry Snapshot with `RegShot`**

1. **Run RegShot** and take a **second snapshot** after malware execution.
2. Use RegShot to **compare the two snapshots**:
    - Focus on any new or modified registry keys, especially in `Run`, `RunOnce`, `Services`, or other startup-related keys.
    - Document any added entries, which might confirm persistence mechanisms.

---

### **Step 7: Analyze Code Behavior with `IDA`**

1. Open `malware.exe` in `IDA`.
2. **Identify the main entry point** and start tracing the code:
    - Observe any API calls that suggest malicious intent, such as `GetProcAddress` for dynamically loading malicious functions or `CreateProcess`.
3. **Inspect Network Functions**:
    - Trace functions like `InternetConnect`, `HttpOpenRequest`, and `recv` for any custom networking code or encoded URLs.
4. **Decode Strings**:
    - If encrypted strings are present, try to identify the decryption routine in IDA and observe the decoded values to understand their purpose.

---

### **Step 8: Document Findings**

1. Compile a report that includes:
    - **IoCs:** Document all network addresses, domains, file paths, and registry keys.
    - **File Behavior:** List any file, registry, and process changes.
    - **Persistence Mechanisms:** Summarize all observed persistence strategies.
    - **Network Indicators:** Include IPs, domains, URLs, and packet patterns.
2. **Identify Indicators for Further Detection**:
    - Use IoCs to help detect or prevent similar threats across the network.

---

### **Step 9: Revert Environment**

1. After analysis, **revert the VM** or sandbox to a clean snapshot to ensure no residual infection.

---

### **Tools Mentioned**

- **`exeinfope.exe`**: Analyze executable packing and obfuscation.
- **`strings.exe`**: Extract human-readable strings from binary files.
- **`HxD`**: Hexadecimal editor to analyze binary files.
- **`PEStudio`**: PE file analysis tool for examining imports, sections, and indicators.
- **`Autoruns`**: Identify autostart locations.
- **`RegShot`**: Compare registry snapshots before and after execution.
- **`Process Monitor`**: Monitor system activity (file, registry, and process monitoring).
- **`FakeNet`**: Simulate network traffic to capture C2 and other network activity.
- **`IDA`**: Interactive Disassembler for reverse-engineering and code analysis.
